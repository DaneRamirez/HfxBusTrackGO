<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HFX Transit Real-Time Bus Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        #control-panel {
            position: fixed;
            top: 50px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
            width: 280px;
        }
        .category-header {
            cursor: pointer;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 4px 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #dee2e6;
        }
        .subcategory-header {
            background: #e9ecef;
            margin-left: 15px;
            padding: 6px 10px;
            font-weight: 500;
        }
        .bus-list {
            display: none;
            margin: 4px 0 8px 25px;
            border-left: 2px solid #adb5bd;
            padding-left: 8px;
        }
        .bus-entry {
            margin: 4px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .bus-label {
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: #2196f3;
            padding: 1px 5px;
            border-radius: 3px;
            border: 1px solid #1976d2;
            min-width: 28px;
            height: 18px;
            line-height: 16px;
            text-align: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        #burger {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            z-index: 1100;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type="checkbox"] {
            transform: scale(1.1);
            accent-color: #2196f3;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <button id="burger">â˜° Toggle Controls</button>
    <div id="control-panel"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([44.65, -63.57], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let allMarkers = {};
        let categoryVisibility = {};
        let individualVisibility = {};
        let routeIdMap = {};

        function getCategory(routeId) {
            const num = parseInt(routeId);
            if (isNaN(num)) return "Other";

            // Parent categories
            if (num <= 50) {
                if (num <= 16) return { parent: "1-50", sub: "1-16" };
                if (num <= 32) return { parent: "1-50", sub: "17-32" };
                return { parent: "1-50", sub: "33-50" };
            }
            if (num <= 100) {
                if (num <= 75) return { parent: "51-100", sub: "51-75" };
                return { parent: "51-100", sub: "76-100" };
            }

            // 50-number buckets for 100+
            const lower = Math.floor((num - 1) / 50) * 50 + 1;
            const upper = lower + 49;
            return { parent: `${lower}-${upper}`, sub: null };
        }

        function updateControlPanel() {
            const panel = document.getElementById("control-panel");
            panel.innerHTML = "";

            // Sort categories numerically
            const sortedCategories = Object.keys(allMarkers).sort((a, b) => {
                const numA = parseInt(a.split('-')[0]);
                const numB = parseInt(b.split('-')[0]);
                return numA - numB;
            });

            sortedCategories.forEach(category => {
                const isParentCategory = ["1-50", "51-100"].includes(category);
                const container = document.createElement("div");

                // Category header
                const header = document.createElement("div");
                header.className = "category-header";

                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.checked = categoryVisibility[category] !== false;

                checkbox.addEventListener("change", () => {
                    const visible = checkbox.checked;
                    categoryVisibility[category] = visible;
                    if (isParentCategory) {
                        Object.keys(allMarkers[category]).forEach(sub => {
                            Object.keys(allMarkers[category][sub]).forEach(busId => {
                                individualVisibility[busId] = visible;
                                const marker = allMarkers[category][sub][busId].marker;
                                visible ? map.addLayer(marker) : map.removeLayer(marker);
                            });
                        });
                    } else {
                        Object.keys(allMarkers[category]).forEach(busId => {
                            individualVisibility[busId] = visible;
                            const marker = allMarkers[category][busId].marker;
                            visible ? map.addLayer(marker) : map.removeLayer(marker);
                        });
                    }
                    updateControlPanel();
                });

                header.append(checkbox, `Routes ${category}`);

                if (isParentCategory) {
                    header.addEventListener("click", e => {
                        if (e.target.tagName !== "INPUT") {
                            const list = header.nextElementSibling;
                            list.style.display = list.style.display === "block" ? "none" : "block";
                        }
                    });
                }

                const content = document.createElement("div");
                content.className = "bus-list";

                if (isParentCategory) {
                    // Add subcategories
                    const subCategories = Object.keys(allMarkers[category]).sort((a, b) =>
                        parseInt(a.split('-')[0]) - parseInt(b.split('-')[0])
                    );

                    subCategories.forEach(sub => {
                        const subHeader = document.createElement("div");
                        subHeader.className = "subcategory-header";

                        const subCheckbox = document.createElement("input");
                        subCheckbox.type = "checkbox";
                        subCheckbox.checked = Object.keys(allMarkers[category][sub]).some(
                            busId => individualVisibility[busId] !== false
                        );

                        subCheckbox.addEventListener("change", () => {
                            const visible = subCheckbox.checked;
                            Object.keys(allMarkers[category][sub]).forEach(busId => {
                                individualVisibility[busId] = visible;
                                const marker = allMarkers[category][sub][busId].marker;
                                visible ? map.addLayer(marker) : map.removeLayer(marker);
                            });
                            updateControlPanel();
                        });

                        subHeader.append(subCheckbox, `Routes ${sub}`);

                        const busList = document.createElement("div");
                        busList.className = "bus-list";

                        Object.keys(allMarkers[category][sub]).sort((a, b) =>
                            parseInt(routeIdMap[a]) - parseInt(routeIdMap[b])
                        ).forEach(busId => {
                            const busEntry = document.createElement("div");
                            busEntry.className = "bus-entry";

                            const busCheckbox = document.createElement("input");
                            busCheckbox.type = "checkbox";
                            busCheckbox.checked = individualVisibility[busId] !== false;
                            busCheckbox.addEventListener("change", () => {
                                individualVisibility[busId] = busCheckbox.checked;
                                const marker = allMarkers[category][sub][busId].marker;
                                busCheckbox.checked ? map.addLayer(marker) : map.removeLayer(marker);
                            });

                            busEntry.append(
                                busCheckbox,
                                `Route ${routeIdMap[busId] || 'N/A'}`
                            );
                            busList.appendChild(busEntry);
                        });

                        content.append(subHeader, busList);
                    });
                } else {
                    // Direct buses for non-parent categories
                    Object.keys(allMarkers[category]).sort((a, b) =>
                        parseInt(routeIdMap[a]) - parseInt(routeIdMap[b])
                    ).forEach(busId => {
                        const busEntry = document.createElement("div");
                        busEntry.className = "bus-entry";

                        const busCheckbox = document.createElement("input");
                        busCheckbox.type = "checkbox";
                        busCheckbox.checked = individualVisibility[busId] !== false;
                        busCheckbox.addEventListener("change", () => {
                            individualVisibility[busId] = busCheckbox.checked;
                            const marker = allMarkers[category][busId].marker;
                            busCheckbox.checked ? map.addLayer(marker) : map.removeLayer(marker);
                        });

                        busEntry.append(
                            busCheckbox,
                            `Route ${routeIdMap[busId] || 'N/A'}`
                        );
                        content.appendChild(busEntry);
                    });
                }

                container.append(header, content);
                panel.appendChild(container);
            });

            // Control buttons
            const btnContainer = document.createElement("div");
            btnContainer.style.marginTop = "15px";
            btnContainer.style.display = "flex";
            btnContainer.style.gap = "8px";

            btnContainer.innerHTML = `
                <button onclick="showAll()">Show All</button>
                <button onclick="hideAll()">Hide All</button>
            `;

            panel.appendChild(btnContainer);
        }

        function showAll() {
            Object.keys(allMarkers).forEach(cat => {
                categoryVisibility[cat] = true;
                if (["1-50", "51-100"].includes(cat)) {
                    Object.keys(allMarkers[cat]).forEach(sub => {
                        Object.keys(allMarkers[cat][sub]).forEach(busId => {
                            individualVisibility[busId] = true;
                            map.addLayer(allMarkers[cat][sub][busId].marker);
                        });
                    });
                } else {
                    Object.keys(allMarkers[cat]).forEach(busId => {
                        individualVisibility[busId] = true;
                        map.addLayer(allMarkers[cat][busId].marker);
                    });
                }
            });
            updateControlPanel();
        }

        function hideAll() {
            Object.keys(allMarkers).forEach(cat => {
                categoryVisibility[cat] = false;
                if (["1-50", "51-100"].includes(cat)) {
                    Object.keys(allMarkers[cat]).forEach(sub => {
                        Object.keys(allMarkers[cat][sub]).forEach(busId => {
                            individualVisibility[busId] = false;
                            map.removeLayer(allMarkers[cat][sub][busId].marker);
                        });
                    });
                } else {
                    Object.keys(allMarkers[cat]).forEach(busId => {
                        individualVisibility[busId] = false;
                        map.removeLayer(allMarkers[cat][busId].marker);
                    });
                }
            });
            updateControlPanel();
        }

        function fetchBusPositions() {
            // Clear existing markers
            Object.values(allMarkers).forEach(cat => {
                if (typeof cat === 'object') {
                    Object.values(cat).forEach(sub => {
                        Object.values(sub).forEach(({ marker }) => map.removeLayer(marker));
                    });
                }
            });
            allMarkers = {};
            routeIdMap = {};

            fetch('/api/positions')
                .then(r => r.json())
                .then(data => {
                    data.forEach(bus => {
                        const { parent, sub } = getCategory(bus.route_id);
                        if (!allMarkers[parent]) allMarkers[parent] = {};

                        if (sub) {
                            // Parent category with subcategories
                            if (!allMarkers[parent][sub]) allMarkers[parent][sub] = {};
                            const icon = L.divIcon({
                                className: 'bus-label',
                                html: `<div>${bus.route_id}</div>`,
                                iconSize: [30, 18]
                            });
                            const marker = L.marker([bus.latitude, bus.longitude], { icon })
                                .bindPopup(`Route ${bus.route_id} - Vehicle ${bus.vehicle_id}`);
                            allMarkers[parent][sub][bus.vehicle_id] = { marker };
                        } else {
                            // Direct category
                            if (!allMarkers[parent]) allMarkers[parent] = {};
                            const icon = L.divIcon({
                                className: 'bus-label',
                                html: `<div>${bus.route_id}</div>`,
                                iconSize: [30, 18]
                            });
                            const marker = L.marker([bus.latitude, bus.longitude], { icon })
                                .bindPopup(`Route ${bus.route_id} - Vehicle ${bus.vehicle_id}`);
                            allMarkers[parent][bus.vehicle_id] = { marker };
                        }
                        routeIdMap[bus.vehicle_id] = bus.route_id;
                    });

                    updateControlPanel();
                })
                .catch(console.error);
        }

        document.getElementById("burger").addEventListener("click", () => {
            const panel = document.getElementById("control-panel");
            panel.style.display = panel.style.display === "none" ? "block" : "none";
        });

        fetchBusPositions();
        setInterval(fetchBusPositions, 15000);
    </script>
</body>
</html>